{% extends "base.html" %}

{% block head_title %}
{% trans %}Sign up{% endtrans %}
{% endblock %}

{% block content %}
{% if errors %}
<div class="alert alert-danger col-md-6 col-md-offset-3">
  {% if errors|count == 1 %}
    {{ errors|first }}
  {% else %}
    <ul>
    {% for error in errors %}
      <li>{{ error }}</li>
    {% endfor %}
    </ul>
  {% endif %}
</div>
{% else %}
<div class="row offset-bottom">
  <div class="col-md-4 col-md-offset-4">
    <form class="form-horizontal" role="form" id="id_form_sign_up" action="{% url api-auth-custom-sign-up %}" method="post">
      <legend>Finish sign up</legend>
      <span class="help-block">{% trans %}Just one step to create your account{% endtrans %}</span>

      {% csrf_token %}

      <div id="non_field_errors" class="alert alert-danger alert-dismissable alerts-placeholder">
        <button type="button" class="close" aria-hidden="true">&times;</button>
        <span id="message_placeholder"></span>
      </div>

      {% for hidden in form.hidden_fields() %}
        {{ hidden|safe }}
      {% endfor %}

      <div class="offset-bottom">
        <div class="input-group">
          <span class="input-group-addon"><span class="glyphicon glyphicon-pencil"></span></span>
          <input type="text" class="form-control" id="id_first_name" name="first_name" data-toggle="tooltip" title="{{ form.first_name.help_text }}" placeholder="{{ form.first_name.label }}" required>
        </div>
      </div>
      <div class="offset-bottom">
        <div class="input-group">
          <span class="input-group-addon"><span class="glyphicon glyphicon-pencil"></span></span>
          <input type="text" class="form-control" id="id_last_name" name="last_name" data-toggle="tooltip" title="{{ form.last_name.help_text }}" placeholder="{{ form.last_name.label }}">
        </div>
      </div>
      <div class="offset-bottom">
        <div class="input-group">
          <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
          <input type="text" class="form-control" id="id_username" name="username" data-toggle="tooltip" title="{{ form.username.help_text }}" placeholder="{{ form.username.label }}" required>
        </div>
      </div>
      <div class="offset-bottom">
        <div class="input-group">
          <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span>
          <input type="password" class="form-control" id="id_password" name="password" data-toggle="tooltip" title="{{ form.password.help_text }}" placeholder="{{ form.password.label }}" required>
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-4 control-label">{% trans %}Email{% endtrans %}</label>
        <div class="col-sm-8">
          <p class="form-control-static">{{ email }}</p>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-offset-4 col-sm-8 has-error alerts-placeholder"></div>
        <label for="select_language" class="col-sm-4 control-label">{{ form.language.label }}</label>
        <div class="col-sm-6">
          <select class="form-control" id="id_language" name="language" data-toggle="tooltip" title="{{ form.language.help_text }}">
          {% for (code, name) in form.language.field.choices %}
            <option title="{{ name }}" value="{{ code }}" title="{{ name }}"{% if code == LANGUAGE_CODE %} selected='selected'{% endif %}>{{ code|native_lang }}</option>
          {% endfor %}
          </select>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-8 col-sm-offset-4">
          <label class="checkbox">
            <input type="checkbox" name="remember_me">
            {{ form.remember_me.label }}
          </label>
        </div>
      </div>
      <button id="id_submit_sign_up" type="submit" class="btn btn-success btn-lg btn-block ladda-button" data-style="zoom-out">{% trans %}Join right now{% endtrans %}!</button>
    </form>
  </div>
</div>
{% endif %}
{% endblock %}


{% block script_extras %}
{% if not errors %}
<script type="text/javascript">
  /* Hide sign up non-field error messages */
  $('#id_form_sign_up #non_field_errors .close').click(function() {
    $(this).parent().hide()
  })
  /* Submit sign up data */
  $('#id_form_sign_up').submit(function(e) {
    e.preventDefault()

    var frm = $(this)
    , url = frm.attr('action')
    , button = frm.find('#id_submit_sign_up').get(0)

    if (typeof button.ladda === "undefined") {
      button.ladda = Ladda.create(button)
    }

    function _show_field_error(container, value) {
      container.addClass('has-error')
      container.prepend('<span class="control-label">' + value + '</span>')
    }

    function _show_non_field_errors(data) {
      frm.find('#message_placeholder').text(data)
      frm.find('#non_field_errors').show()
    }

    function _show_fatal_error(data) {
      var container = frm.parent()
      , wrapper = container.parent()

      container.remove()
      wrapper.prepend('<div class="alert alert-danger col-md-6 col-md-offset-3">' + data + '</div>')
    }

    frm.find('.alerts-placeholder').hide()
    $('.has-error span.control-label').remove()
    $('.has-error').removeClass('has-error')

    button.ladda.start()
    $.post(url
      , frm.serialize()
      , function(response) {
        if (response.status == 'success') {
          window.location = response.redirect_url
        } else {
          if (response.error.code == {{ form.FATAL_ERROR_CODE }}) {
            _show_fatal_error(response.error.message)
          } else if (typeof response.errors != 'undefined') {
            var fatal_errors = []
            if (typeof response.errors.email != 'undefined') {
              fatal_errors.push(response.errors.email)
            }
            if (typeof response.errors.confirmation_key != 'undefined') {
              fatal_errors.push(response.errors.confirmation_key)
            }
            if (fatal_errors.length) {
              if (fatal_errors.length == 1) {
                var data = fatal_errors[0]
              } else {
                var data = "<ul>"
                for (var i in fatal_errors) {
                  data = data + "<li>" + fatal_errors[i] + "</li>"
                }
                data = data + "</ul>"
              }
              _show_fatal_error(data)
            } else {
              for (var key in response.errors) {
                if (response.errors.hasOwnProperty(key)) {
                  var element = $('#id_' + key)
                  , container = element.parent().parent()

                  if (key == 'language') {
                    container = container.find('.alerts-placeholder')
                    _show_field_error(container, response.errors[key])
                    element.parent().addClass('has-error')
                    container.show()
                  } else {
                    _show_field_error(container, response.errors[key])
                  }
                }
              }
            }
          } else {
            _show_non_field_errors(response.error.message)
          }
        }
      }
      , "json"
    ).fail(function(request, status, error) {
      _show_non_field_errors("{% trans %}Request execution error{% endtrans %}")
    }).always(function(data) {
      button.ladda.stop()
    })

    return false
  })
</script>
{% endif %}
{% endblock %}
